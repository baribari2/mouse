package calldec

import (
	"testing"

	"github.com/baribari2/mouse/common/types"
)

func TestDecodeCalldata(t *testing.T) {
	m := &types.MouseTx{}
	m.RawCalldata = "0x095ea7b3000000000000000000000000b9911ab699fd781efda446e7fd995d375b437c8b000000000000000000000000000000000000000019d971e4fe8401e740000000"

	err := DecodeCalldata(m)
	if err != nil {
		t.Fatalf("error decoding calldata: %v", err)
	}

	if m.PossibleSignatures[0].TextSignature != "approve(address,uint256)" {
		t.Fatalf("signature mismatch: %v", m.PossibleSignatures[0].TextSignature)
	}
}

func TestDecodeComplexCalldata(t *testing.T) {
	m := &types.MouseTx{}
	m.RawCalldata = "0xe7acab24000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000006600000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000005a000000000000000000000000090b56d0e27e74c3c5e66ebfcaf12dc5ecf0665dd000000000000000000000000004c00500000ad104d7dbd00e3ae0a5c00560c000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000063d524260000000000000000000000000000000000000000000000000000000063fe02a60000000000000000000000000000000000000000000000000000000000000000360c6ebe000000000000000000000000000000000000000078cf8bfa912e5dae0000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f0000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000286e531f363768fed5e18b468f5b76a9ffc33af5000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000fbea7347bbc00000000000000000000000000000000000000000000000000000fbea7347bbc00000000000000000000000000090b56d0e27e74c3c5e66ebfcaf12dc5ecf0665dd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006c00a3912c0000000000000000000000000000000000000000000000000000006c00a3912c0000000000000000000000000000000a26b00c1f0df003000390027140000faa719000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b571b6a1f8000000000000000000000000000000000000000000000000000000b571b6a1f8000000000000000000000000000f3fcf8ba1bae196407bc77d8b56520f7831a73e30000000000000000000000000000000000000000000000000000000000000041fac2ec381bde493ce204a6ab4083108a6aa59d92409fcd69ac8d41ab24e6e38f35f07bdc3e1e272f8dbfdf12089d1912d7a7349523e1d7e3f0dfb585adbd2a371c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000360c6ebe"

	err := DecodeCalldata(m)
	if err != nil {
		t.Fatalf("error decoding calldata: %v", err)
	}

	if m.PossibleSignatures[0].TextSignature != "fulfillAdvancedOrder(((address,address,(uint8,address,uint256,uint256,uint256)[],(uint8,address,uint256,uint256,uint256,address)[],uint8,uint256,uint256,bytes32,uint256,bytes32,uint256),uint120,uint120,bytes,bytes),(uint256,uint8,uint256,uint256,bytes32[])[],bytes32,address)" {
		t.Fatalf("signature mismatch: %v", m.PossibleSignatures[0].TextSignature)
	}
}

func TestNo0x(t *testing.T) {
	m := &types.MouseTx{}
	m.RawCalldata = "095ea7b3000000000000000000000000b9911ab699fd781efda446e7fd995d375b437c8b000000000000000000000000000000000000000019d971e4fe8401e740000000"

	err := DecodeCalldata(m)
	if err != nil {
		t.Fatalf("error decoding calldata: %v", err)
	}

	t.Log(m.PossibleSignatures[0].TextSignature)

	if m.PossibleSignatures[0].TextSignature != "approve(address,uint256)" {
		t.Fatalf("signature mismatch: %v", m.PossibleSignatures[0].TextSignature)
	}
}
